apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: endpoint-task
spec:
  params:
    - name: public-endpoint
      description: Publicly available endpoint
    - name: private-endpoint
      description: Privately accessible only endpoint
  steps:
    - name: test-public-endpoint
      image: jerhoconnor/toolbox
      imagePullPolicy: IfNotPresent
      envFrom:
        - configMapRef:
            name: environment-properties
        - secretRef:
            name: secure-properties     
      command: ["/bin/bash", "-c"]
      args:
        - ${debug};
          echo -e "Testing \033[36mPUBLIC\033[0m endpoint";
          env;
          echo dig;
          dig +short ${public_endpoint}; 
          echo curl;
          curl https://${public_endpoint}/status;
      steps:
    - name: test-private-endpoint
      image: jerhoconnor/toolbox
      imagePullPolicy: IfNotPresent
      envFrom:
        - configMapRef:
            name: environment-properties
        - secretRef:
            name: secure-properties     
      command: ["/bin/bash", "-c"]
      args:
        - ${debug};
          echo -e "Testing \033[36mPUBLIC\033[0m endpoint";
          env;
          echo dig;
          dig +short ${private_endpoint}; 
          echo curl;
          curl -v https://${private_endpoint}/status;
          echo COS;
          ibmcloud config --check-version=false;
          ibmcloud login --apikey ${MYAPIKEY} -r us-south;
          ibmcloud plugin install -f cloud-object-storage;
          ibmcloud cos config crn --crn fdcaf149-c28b-4cc7-becf-9cfa52fcba04;
          ibmcloud cos buckets;
          ibmcloud cos objects --bucket pipeline-evidence-2;
          echo FIN;
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cm-toolchain-props
spec:
  steps:
    - name: cm-show-toolchain-env
      image: ubuntu
      envFrom:
        - configMapRef:
            name: toolchain  
      command: ["/bin/bash", "-c"]
      args:
        - set -x
          echo -e "The \033[36menvironment\033[0m for this Step is ";
          env
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: call-the-pipe-cleaner
spec:
  steps:
    - name: call-another-pipeline
      image: ubuntu
      envFrom:
        - configMapRef:
            name: environment-properties     
      command: ["/bin/bash", "-c"]
      args:
        - set -x
          apt-get install -y wget;
          wget -qO- https://devops-api.us-south.devops.dev.cloud.ibm.com/v1/tekton-webhook/b9dd6e81-f195-40ab-b308-502b15ea88a6/run/29da21ff-6d4e-4e1d-9bac-b5db4eed4cbb --post-data="" | jq '.'
---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cm-event-parameters
spec:
  steps:
    - name: cm-show-event-env
      image: ubuntu
      envFrom:
        - configMapRef:
            name: event-parameters  
      command: ["/bin/bash", "-c"]
      args:
        - set -x
          echo -e "The \033[36menvironment\033[0m including \033[36mevent-parameters\033[0m is ";
          env
    - name: cm-show-event-keys
      image: ubuntu
      envFrom:
        - configMapKeyRef:
            name: eventHeader
        - configMapKeyRef:
            name: eventBody         